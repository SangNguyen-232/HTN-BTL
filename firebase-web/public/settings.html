<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Settings - CoreIOT Configuration</title>
  <link rel="stylesheet" href="/css/styles.css">
  <style>
    h2{ margin:6px 0 14px; }
    
    .status-banner{
      background: linear-gradient(135deg, rgba(34,197,94,0.15), rgba(16,185,129,0.10));
      border:1px solid rgba(34,197,94,0.3);
      border-radius:12px;
      padding:12px 16px;
      margin-bottom:16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    .status-info{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .status-mode{
      font-weight:700;
      color:#86efac;
      font-size:14px;
    }
    .status-ip{
      font-size:12px;
      color:var(--muted);
      font-family:monospace;
    }
    .status-icon{
      width:24px;
      height:24px;
      color:#86efac;
    }
    
    form{
      display:grid;
      gap:12px;
    }
    .form-label{
      font-size:13px;
      color:var(--muted);
      margin-bottom:6px;
      font-weight:600;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .form-label svg{
      width:14px;
      height:14px;
    }
    .input{
      background: transparent;
      border:0;
      color:var(--text);
      width:100%;
      font-size:15px;
      outline:none;
      padding:0;
    }
    .input::placeholder{
      color:rgba(156,163,175,0.5);
    }
    .field,
    .password-field{
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
      border-radius:12px;
      padding:12px 14px;
      transition: border-color .2s ease, background .2s ease;
    }
    .field:focus-within,
    .password-field:focus-within{
      border-color: rgba(59,130,246,0.5);
      background: rgba(255,255,255,.06);
    }
    .password-field{ display:flex; align-items:center; gap:8px; }
    .input-group{
      display:grid;
      gap:6px;
    }
    .toggle-pass{
      appearance:none;
      border:0;
      background: rgba(255,255,255,0.08);
      color:var(--muted);
      padding:6px 12px;
      border-radius:999px;
      font-size:12px;
      font-weight:600;
      cursor:pointer;
      transition: background .2s ease,color .2s ease;
    }
    .toggle-pass:hover{
      background: rgba(59,130,246,0.25);
      color:#dbeafe;
    }
    .row{
      display:flex;
      gap:10px;
    }
    .primary{
      appearance:none;border:0;cursor:pointer;font-weight:700;
      color:white;
      background: linear-gradient(180deg, rgba(59,130,246,.25), rgba(59,130,246,.15));
      border:1px solid rgba(59,130,246,.45);
      padding:10px 14px;border-radius:12px;
      flex:1;
    }
    .ghost{
      appearance:none;border:1px solid rgba(255,255,255,.15);cursor:pointer;font-weight:700;
      color:var(--text);
      background: transparent;
      padding:10px 14px;border-radius:12px;
      flex:1;
      transition: all .2s ease;
    }
    .primary:hover{
      background: linear-gradient(180deg, rgba(59,130,246,.35), rgba(59,130,246,.25));
      transform: translateY(-1px);
      box-shadow: 0 6px 18px rgba(59,130,246,.3);
    }
    .ghost:hover{
      background: rgba(255,255,255,0.05);
      border-color: rgba(255,255,255,0.25);
    }
    .primary:disabled{
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    #msg{ 
      margin-top:12px; 
      padding:12px 14px;
      border-radius:10px;
      font-size:13px;
      font-weight:600;
      display:none;
    }
    #msg.info{
      display:block;
      background: rgba(59,130,246,0.15);
      border:1px solid rgba(59,130,246,0.3);
      color:#93c5fd;
    }
    #msg.success{
      display:block;
      background: rgba(34,197,94,0.15);
      border:1px solid rgba(34,197,94,0.3);
      color:#86efac;
    }
    #msg.error{
      display:block;
      background: rgba(239,68,68,0.15);
      border:1px solid rgba(239,68,68,0.3);
      color:#fca5a5;
    }
    
    .spinner{
      display:inline-block;
      width:16px;
      height:16px;
      border:2px solid rgba(255,255,255,0.2);
      border-top-color:#93c5fd;
      border-radius:50%;
      animation:spin 0.8s linear infinite;
      vertical-align:middle;
      margin-right:8px;
    }
    @keyframes spin{
      to{ transform:rotate(360deg); }
    }
    
    .info-box{
      background: rgba(59,130,246,0.08);
      border:1px solid rgba(59,130,246,0.2);
      border-radius:12px;
      padding:12px 14px;
      margin-top:14px;
      font-size:13px;
      color:var(--muted);
      line-height:1.5;
    }
    .info-box strong{
      color:#93c5fd;
      font-weight:600;
    }
    .info-box code{
      background: rgba(255,255,255,0.08);
      padding:2px 6px;
      border-radius:4px;
      font-family:monospace;
      font-size:12px;
      color:#dbeafe;
    }
  </style>
</head>
<body>
  <div class="app-layout">
    <div class="mobile-nav-toggle" onclick="toggleSidebar()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <line x1="3" y1="6" x2="21" y2="6"></line>
        <line x1="3" y1="12" x2="21" y2="12"></line>
        <line x1="3" y1="18" x2="21" y2="18"></line>
      </svg>
    </div>
    
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-brand">
          <div class="logo"></div>
          <span>ESP32 IoT</span>
        </div>
      </div>
      
      <nav class="sidebar-nav">
        <div class="nav-item">
          <a href="/" class="nav-link">
            <div class="nav-icon">
              <svg viewBox="0 0 24 24">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                <polyline points="9,22 9,12 15,12 15,22"></polyline>
              </svg>
            </div>
            Dashboard
          </a>
        </div>
        
        <div class="nav-item">
          <a href="/settings.html" class="nav-link active">
            <div class="nav-icon">
              <svg viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M12 1v6m0 12v6m11-7h-6m-12 0H1m15.5-6.5l-4.24 4.24M6.74 6.74L2.5 2.5m15 15l-4.24-4.24M6.74 17.26L2.5 21.5"></path>
              </svg>
            </div>
            Settings
          </a>
        </div>
      </nav>
    </div>
    
    <div class="main-content">
      <div class="container">
        <div class="header" style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
          <div class="title" style="font-weight:700;font-size:20px;">Settings</div>
        </div>

        <div class="status-banner">
          <div class="status-info">
            <div class="status-mode">Firebase Frontend</div>
            <div class="status-ip">CoreIOT Configuration</div>
          </div>
          <svg class="status-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M5 12.55a11 11 0 0 1 14.08 0"></path>
            <path d="M1.42 9a16 16 0 0 1 21.16 0"></path>
            <path d="M8.53 16.11a6 6 0 0 1 6.95 0"></path>
            <line x1="12" y1="20" x2="12.01" y2="20"></line>
          </svg>
        </div>

        <h2>CoreIOT Configuration</h2>
        <form id="coreiot-form" onsubmit="saveCoreIOTConfig(event)">
          <div class="input-group">
            <label class="form-label">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                <line x1="12" y1="22.08" x2="12" y2="12"></line>
              </svg>
              CoreIOT Server
            </label>
            <div class="field">
              <input type="text" class="input" id="coreiot-server" placeholder="app.coreiot.io" required>
            </div>
          </div>

          <div class="input-group">
            <label class="form-label">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
              </svg>
              CoreIOT Access Token
            </label>
            <div class="password-field">
              <input type="password" class="input" id="coreiot-token" placeholder="Nhập Access Token" required>
              <button type="button" class="toggle-pass" onclick="togglePassword()">Show</button>
            </div>
          </div>

          <div id="msg"></div>

          <div class="row">
            <button type="submit" class="primary" id="save-btn">
              <span id="save-text">Save Configuration</span>
            </button>
            <button type="button" class="ghost" onclick="testConnection()">Test Connection</button>
          </div>
        </form>

        <div class="info-box">
          <strong>Hướng dẫn:</strong><br>
          • Nhập <code>CoreIOT Server</code> (ví dụ: app.coreiot.io)<br>
          • Nhập <code>Access Token</code> từ ESP32 đã cấu hình<br>
          • Sau khi lưu, frontend sẽ tự động lấy dữ liệu từ CoreIOT<br>
          • Dữ liệu được ESP32 gửi lên CoreIOT sẽ hiển thị trên Dashboard
        </div>
      </div>
    </div>
  </div>

  <script src="/js/config.js"></script>
  <script>
    // Load existing config
    window.addEventListener('DOMContentLoaded', function() {
      const serverInput = document.getElementById('coreiot-server');
      const tokenInput = document.getElementById('coreiot-token');
      
      if (COREIOT_CONFIG.server) {
        serverInput.value = COREIOT_CONFIG.server;
      }
      if (COREIOT_CONFIG.token) {
        tokenInput.value = COREIOT_CONFIG.token;
      }
    });

    function saveCoreIOTConfig(event) {
      event.preventDefault();
      
      const serverInput = document.getElementById('coreiot-server');
      const tokenInput = document.getElementById('coreiot-token');
      const msgEl = document.getElementById('msg');
      const saveBtn = document.getElementById('save-btn');
      const saveText = document.getElementById('save-text');
      
      const server = serverInput.value.trim();
      const token = tokenInput.value.trim();
      
      if (!server || !token) {
        msgEl.className = 'error';
        msgEl.textContent = 'Vui lòng nhập đầy đủ thông tin!';
        return;
      }
      
      // Disable button
      saveBtn.disabled = true;
      saveText.innerHTML = '<span class="spinner"></span>Saving...';
      
      // Save config
      COREIOT_CONFIG.server = server;
      COREIOT_CONFIG.token = token;
      COREIOT_CONFIG.save();
      
      // Test connection
      fetchCoreIOTData().then(data => {
        if (data) {
          msgEl.className = 'success';
          msgEl.textContent = 'Đã lưu cấu hình thành công! Đang kết nối với CoreIOT...';
          
          setTimeout(() => {
            window.location.href = '/';
          }, 1500);
        } else {
          msgEl.className = 'error';
          msgEl.textContent = 'Lưu thành công nhưng không thể kết nối với CoreIOT. Vui lòng kiểm tra lại thông tin.';
          saveBtn.disabled = false;
          saveText.textContent = 'Save Configuration';
        }
      }).catch(err => {
        msgEl.className = 'error';
        msgEl.textContent = 'Lỗi: ' + err.message;
        saveBtn.disabled = false;
        saveText.textContent = 'Save Configuration';
      });
    }

    async function testConnection() {
      const serverInput = document.getElementById('coreiot-server');
      const tokenInput = document.getElementById('coreiot-token');
      const msgEl = document.getElementById('msg');
      
      const server = serverInput.value.trim();
      const token = tokenInput.value.trim();
      
      if (!server || !token) {
        msgEl.className = 'error';
        msgEl.textContent = 'Vui lòng nhập đầy đủ thông tin trước khi test!';
        return;
      }
      
      // Temporarily set config
      const originalServer = COREIOT_CONFIG.server;
      const originalToken = COREIOT_CONFIG.token;
      COREIOT_CONFIG.server = server;
      COREIOT_CONFIG.token = token;
      
      msgEl.className = 'info';
      msgEl.textContent = 'Đang kiểm tra kết nối...';
      
      try {
        const data = await fetchCoreIOTData();
        if (data) {
          msgEl.className = 'success';
          msgEl.textContent = 'Kết nối thành công! Đã nhận được dữ liệu từ CoreIOT.';
        } else {
          msgEl.className = 'error';
          msgEl.textContent = 'Không thể kết nối với CoreIOT. Vui lòng kiểm tra lại Server và Token.';
        }
      } catch (err) {
        msgEl.className = 'error';
        msgEl.textContent = 'Lỗi kết nối: ' + err.message;
      } finally {
        // Restore original config
        COREIOT_CONFIG.server = originalServer;
        COREIOT_CONFIG.token = originalToken;
      }
    }

    function togglePassword() {
      const tokenInput = document.getElementById('coreiot-token');
      const toggleBtn = event.target;
      
      if (tokenInput.type === 'password') {
        tokenInput.type = 'text';
        toggleBtn.textContent = 'Hide';
      } else {
        tokenInput.type = 'password';
        toggleBtn.textContent = 'Show';
      }
    }

    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      if (sidebar) {
        sidebar.classList.toggle('open');
      }
    }

    // Close sidebar when clicking outside on mobile
    document.addEventListener('click', function(e) {
      const sidebar = document.getElementById('sidebar');
      const toggle = document.querySelector('.mobile-nav-toggle');
      if (window.innerWidth <= 768 && sidebar && toggle && !sidebar.contains(e.target) && !toggle.contains(e.target)) {
        sidebar.classList.remove('open');
      }
    });
  </script>
</body>
</html>

